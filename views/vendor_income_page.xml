<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Vendor Income/Commission Tracking Page -->
    <template id="vendor_income_page" name="Vendor Income and Commission">
        <t t-call="marketplace_platform.minimal_layout">
            <div id="wrap" class="bg-light-cream" style="min-height: 100vh;">
                
                <!-- Global Header -->
                <t t-call="marketplace_platform.navbar_component"/>
                
                <!-- Vendor Sub-Navbar -->
                <t t-call="marketplace_platform.vendor_navbar_component"/>
                
                <!-- Income Content -->
                <div class="vendor-content-wrapper">
                    <div class="container py-5">
                        
                        <!-- Header -->
                        <div class="d-flex justify-content-between align-items-center mb-5">
                            <div>
                                <h2 class="fw-bold text-dark mb-1">Income &amp; Commissions</h2>
                                <p class="text-muted mb-0">Track your earnings and commission history</p>
                            </div>
                            <a href="/my/marketplace/payout/request" class="btn btn-success rounded-pill px-4 shadow-sm">
                                <i class="fa fa-money me-2"/> Request Payout
                            </a>
                        </div>

                        <!-- Income Summary Cards -->
                        <div class="row g-4 mb-5">
                            <!-- Total Earnings -->
                            <div class="col-md-3 col-sm-6">
                                <div class="vendor-stat-card">
                                    <div class="stat-icon-wrapper green">
                                        <i class="fa fa-dollar"/>
                                    </div>
                                    <h3 class="fw-bold mb-1" t-options="{'widget': 'monetary', 'display_currency': vendor.currency_id}" t-esc="total_earnings"/>
                                    <p class="text-muted small mb-0">Total Earnings</p>
                                </div>
                            </div>
                            
                            <!-- Platform Commission -->
                            <div class="col-md-3 col-sm-6">
                                <div class="vendor-stat-card">
                                    <div class="stat-icon-wrapper orange">
                                        <i class="fa fa-percent"/>
                                    </div>
                                    <h3 class="fw-bold mb-1" t-options="{'widget': 'monetary', 'display_currency': vendor.currency_id}" t-esc="total_commission"/>
                                    <p class="text-muted small mb-0">Platform Commission</p>
                                </div>
                            </div>
                            
                            <!-- Net Income -->
                            <div class="col-md-3 col-sm-6">
                                <div class="vendor-stat-card">
                                    <div class="stat-icon-wrapper blue">
                                        <i class="fa fa-chart-line"/>
                                    </div>
                                    <h3 class="fw-bold mb-1" t-options="{'widget': 'monetary', 'display_currency': vendor.currency_id}" t-esc="net_income"/>
                                    <p class="text-muted small mb-0">Net Income</p>
                                </div>
                            </div>
                            
                            <!-- Available Balance -->
                            <div class="col-md-3 col-sm-6">
                                <div class="vendor-stat-card">
                                    <div class="stat-icon-wrapper purple">
                                        <i class="fa fa-wallet"/>
                                    </div>
                                    <h3 class="fw-bold mb-1" t-options="{'widget': 'monetary', 'display_currency': vendor.currency_id}" t-esc="available_balance"/>
                                    <p class="text-muted small mb-0">Available Balance</p>
                                </div>
                            </div>
                        </div>

                        <!-- Commission History Table -->
                        <div class="bg-white rounded-4 shadow-sm p-4 border">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <h5 class="fw-bold m-0">Commission History</h5>
                                <div class="btn-group btn-group-sm" role="group">
                                    <button type="button" class="btn btn-outline-primary active">All</button>
                                    <button type="button" class="btn btn-outline-primary">Confirmed</button>
                                    <button type="button" class="btn btn-outline-primary">Paid</button>
                                </div>
                            </div>
                            
                            <t t-if="commissions">
                                <!-- Income Chart (Placeholder - can use Chart.js) -->
                                <div class="mb-4 p-4 bg-light rounded">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <h6 class="fw-bold m-0">Earnings Overview</h6>
                                        <div class="btn-group btn-group-sm" role="group">
                                            <button type="button" class="btn btn-outline-secondary active" onclick="changeIncomeChartType('line')">
                                                <i class="fa fa-line-chart"/> Line
                                            </button>
                                            <button type="button" class="btn btn-outline-secondary" onclick="changeIncomeChartType('bar')">
                                                <i class="fa fa-bar-chart"/> Bar
                                            </button>
                                            <button type="button" class="btn btn-outline-secondary" onclick="changeIncomeChartType('doughnut')">
                                                <i class="fa fa-pie-chart"/> Doughnut
                                            </button>
                                        </div>
                                    </div>
                                    <div style="height: 250px; position: relative;">
                                        <canvas id="earningsChart"></canvas>
                                    </div>
                                </div>
                                
                                <div class="table-responsive">
                                    <table class="table table-hover align-middle">
                                        <thead class="bg-light">
                                            <tr>
                                                <th class="border-0 rounded-start">Reference</th>
                                                <th class="border-0">Order</th>
                                                <th class="border-0">Date</th>
                                                <th class="border-0">Sale Amount</th>
                                                <th class="border-0">Commission</th>
                                                <th class="border-0">Your Earning</th>
                                                <th class="border-0 rounded-end">Status</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <t t-foreach="commissions" t-as="comm">
                                                <tr>
                                                    <td class="fw-bold"><t t-esc="comm.name"/></td>
                                                    <td><t t-esc="comm.order_line_id.order_id.name"/></td>
                                                    <td class="small text-muted"><t t-esc="comm.create_date" t-options='{"widget": "date"}'/></td>
                                                    <td>
                                                        <span t-field="comm.sale_amount" 
                                                              t-options="{'widget': 'monetary', 'display_currency': comm.currency_id}"/>
                                                    </td>
                                                    <td class="text-danger">
                                                        -<span t-field="comm.amount_commission" 
                                                              t-options="{'widget': 'monetary', 'display_currency': comm.currency_id}"/>
                                                    </td>
                                                    <td class="text-success fw-bold">
                                                        <span t-field="comm.vendor_amount" 
                                                              t-options="{'widget': 'monetary', 'display_currency': comm.currency_id}"/>
                                                    </td>
                                                    <td>
                                                        <span t-if="comm.state == 'draft'" class="badge bg-secondary">Draft</span>
                                                        <span t-elif="comm.state == 'confirmed'" class="badge bg-primary">Confirmed</span>
                                                        <span t-elif="comm.state == 'paid'" class="badge bg-success">Paid</span>
                                                    </td>
                                                </tr>
                                            </t>
                                        </tbody>
                                    </table>
                                </div>
                                
                                <!-- Chart.js Script -->
                                <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
                                <script>
                                    let earningsChart;
                                    
                                    const commissionData = {
                                        labels: [
                                            <t t-foreach="commissions[:10]" t-as="comm">
                                                '<t t-esc="comm.create_date.strftime('%m/%d') if comm.create_date else 'N/A'"/>',
                                            </t>
                                        ],
                                        earnings: [
                                            <t t-foreach="commissions[:10]" t-as="comm">
                                                <t t-esc="float(comm.vendor_amount or 0)"/>,
                                            </t>
                                        ],
                                        commissions: [
                                            <t t-foreach="commissions[:10]" t-as="comm">
                                                <t t-esc="float(comm.amount_commission or 0)"/>,
                                            </t>
                                        ]
                                    };
                                    
                                    function createIncomeChart(type = 'line') {
                                        const ctx = document.getElementById('earningsChart');
                                        if (!ctx) return;
                                        
                                        if (earningsChart) {
                                            earningsChart.destroy();
                                        }
                                        
                                        const datasets = type === 'doughnut' ? [{
                                            label: 'Earnings',
                                            data: commissionData.earnings,
                                            backgroundColor: [
                                                '#4CAF50', '#66BB6A', '#81C784', '#A5D6A7', 
                                                '#C8E6C9', '#E8F5E9', '#F1F8E9', '#DCEDC8',
                                                '#C5E1A5', '#AED581'
                                            ],
                                            borderWidth: 2
                                        }] : [{
                                            label: 'Your Earnings',
                                            data: commissionData.earnings,
                                            borderColor: '#4CAF50',
                                            backgroundColor: type === 'line' ? 'rgba(76, 175, 80, 0.1)' : '#4CAF50',
                                            tension: 0.4,
                                            borderRadius: type === 'bar' ? 8 : 0,
                                            fill: type === 'line'
                                        }, {
                                            label: 'Platform Commission',
                                            data: commissionData.commissions,
                                            borderColor: '#FF9800',
                                            backgroundColor: type === 'line' ? 'rgba(255, 152, 0, 0.1)' : '#FF9800',
                                            tension: 0.4,
                                            borderRadius: type === 'bar' ? 8 : 0,
                                            fill: type === 'line'
                                        }];
                                        
                                        const config = {
                                            type: type,
                                            data: {
                                                labels: commissionData.labels,
                                                datasets: datasets
                                            },
                                            options: {
                                                responsive: true,
                                                maintainAspectRatio: false,
                                                plugins: {
                                                    legend: { 
                                                        display: true,
                                                        position: type === 'doughnut' ? 'right' : 'top'
                                                    },
                                                    tooltip: {
                                                        callbacks: {
                                                            label: function(context) {
                                                                const value = type === 'doughnut' ? context.parsed : context.parsed.y;
                                                                return context.dataset.label + ': $' + value.toFixed(2);
                                                            }
                                                        }
                                                    }
                                                },
                                                scales: type !== 'doughnut' ? {
                                                    y: { 
                                                        beginAtZero: true,
                                                        ticks: {
                                                            callback: function(value) {
                                                                return '$' + value.toFixed(0);
                                                            }
                                                        }
                                                    }
                                                } : {}
                                            }
                                        };
                                        
                                        earningsChart = new Chart(ctx, config);
                                    }
                                    
                                    function changeIncomeChartType(type) {
                                        // Update active button
                                        document.querySelectorAll('.btn-group button').forEach(btn => {
                                            btn.classList.remove('active');
                                        });
                                        event.target.closest('button').classList.add('active');
                                        
                                        createIncomeChart(type);
                                    }
                                    
                                    document.addEventListener('DOMContentLoaded', function() {
                                        createIncomeChart('line');
                                    });
                                </script>
                            </t>
                            <t t-else="">
                                <div class="text-center py-5">
                                    <i class="fa fa-chart-line fa-3x text-muted opacity-25 mb-3"/>
                                    <p class="text-muted">No commission records yet</p>
                                    <p class="small text-muted">Commissions will appear here once customers purchase your products.</p>
                                </div>
                            </t>
                        </div>
                        
                    </div>
                </div>
                
            </div>
        </t>
    </template>
</odoo>
